<!DOCTYPE html>
<html>
    <head>
      <title>People Counting</title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
      <!-- Latest compiled and minified CSS -->

      <!-- Latest compiled and minified JavaScript -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
      <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>

    </head>
    <body>
      


    <div class="container">
      <div class="panel panel-info" id="instructionsPanel">
        <div class="panel-heading">
          <h3 class="panel-title">
          <a class="accordion-toggle" data-toggle="collapse" data-parent="#instructionsPanel" href="#instructions">Instructions</a></h3>
        </div>
        <div class="panel-body panel-collapse collapse in" id="instructions">
          <p>Count the number of unique people that appear in each photo.</p>
          <ul>
              <li>To count the people in each picture, just click on each distinguishable person in the image to help you count.</li>
              <li>To remove a marking, just click on it.</li>
              <li>A counter will keep track of the number of people for you.</li>
              <li>Use the previous and next buttons to navigate to the previous or next image.</li>
          </ul>
          
          <p>You will be paid a flat rate for completing the HIT, and then earn a bonus of $0.01 for every 5 people you identify</p>
          
          <p>Here are some examples to help you:</p>
          <ul>
            <li>Example 1</li>
            <li>Example 2</li>
            <li>Example 3</li>
          </ul>
          
          <p>Feel free to collapse this instruction panel by clicking on the "Instructions" title.</p>
        </div>
      </div>
      
    
      <section class="container" id="photo1" style="height:150vh;padding-top:100px;">
        <section class="container">
          <div class="row">
                <canvas id="canvas1" onclick="draw(event, this.id)"></canvas>
                <img class="img-responsive" src="images/people1.jpg" id="image1" style="width:100%;display:none;">

          </div>
        </section>
        
        <section class="container">
          <div class="row">
            <form>
              <div class="form-group" id="mturk_form">
                <label for="personCount1"><h4>How many people?</h4></label>
                <span id="personCount1"><h2>0</h2></span>
              </div>
            </form><!-- /.form -->
              
            <nav>
              <ul class="pager">
                <li class="next"><a href="#photo2">Next Image <span id="thing" aria-hidden="true">&rarr;</span></a></li>
              </ul>
            </nav>
          </div>
        </section><!-- /.container -->
      </section>
        
        <section class="container" id="photo2" style="height:125vh; padding-top:100px;">
          <div class="row">
            <canvas id="canvas2" onclick="draw(event, this.id)"></canvas>
            <img class="img-responsive" src="images/people2.jpg" id="image2" style="width:100%;display:none;">
          </div>
          <div class="row">
            <form>
              <div class="form-group" id="mturk_form">
                <label for="personCount2"><h4>How many people?</h4></label>
                <span id="personCount2"><h2>0</h2></span>
              </div>
            </form><!-- /.form -->
              
            <nav>
              <ul class="pager">
                <li class="previous"><a href="#photo1"><span aria-hidden="true">&larr;</span> Previous Image</a></li>
                <li class="next"><a href="#photo3">Next Image <span id="thing" aria-hidden="true">&rarr;</span></a></li>
              </ul>
            </nav>
              
          </div><!-- row -->
        </section><!-- container -->
        
        <section class="container" style="height:125vh; padding-top:100px;" id="photo3">
            <div class="row">
              <canvas id="canvas3" onclick="draw(event, this.id)"></canvas>
                <img class="img-responsive" src="images/people3.jpg" id="image3" style="width:100%;display:none;">
            </div>
            <div class="row">
              <form>
                <div class="form-group" id="mturk_form">
                  <label for="personCount3"><h4>How many people?</h4></label>
                  <span id="personCount3"><h2>0</h2></span>
                </div>
              </form><!-- /.form -->
              
              <nav>
                <ul class="pager">
                  <li class="previous"><a href="#photo2"><span aria-hidden="true">&larr;</span> Previous Image</a></li>
                  <li class="next"><a href="#photo4">Next Image <span id="thing" aria-hidden="true">&rarr;</span></a></li>
                </ul>
              </nav>
            </div><!-- row -->
        </section><!-- container -->

        <section class="container" id="photo4" style="height:125vh; padding-top:100px;">
            <div class="row">
              <canvas id="canvas4" onclick="draw(event, this.id)"></canvas>
                <img class="img-responsive" src="images/people4.jpg" id="image4" style="width:100%;display:none;">
            </div>
            <div class="row">
              <form>
                <div class="form-group" id="mturk_form">
                  <label for="personCount4"><h4>How many people?</h4></label>
                  <span id="personCount4"><h2>0</h2></span>
                </div>
              </form><!-- /.form -->
              
              <nav>
                <ul class="pager">
                  <li class="previous"><a href="#photo3"><span aria-hidden="true">&larr;</span> Previous Image</a></li>
                  <li class="next"><a href="#photo5">Next Image <span id="thing" aria-hidden="true">&rarr;</span></a></li>
                </ul>
              </nav>
            </div><!-- row -->
        </section><!-- container -->
        
        <section class="container" id="photo5" style="height:125vh; padding-top:100px;">
            <div class="row">
              <canvas id="canvas5" onclick="draw(event, this.id)"></canvas>
              <img class="img-responsive" src="images/people5.jpg" id="image5" style="width:100%;display:none;">
            </div>
            <div class="row">
              <form>
                <div class="form-group" id="mturk_form">
                  <label for="personCount5"><h4>How many people?</h4></label>
                  <span id="personCount5"><h2>0</h2></span>
                </div>
              </form><!-- /.form -->
              
              <nav>
                <ul class="pager">
                  <li class="previous"><a href="#photo4"><span aria-hidden="true">&larr;</span> Previous Image</a></li>
                  <li class="next"><a href="#photo6">Next Image <span id="thing" aria-hidden="true">&rarr;</span></a></li>
                </ul>
              </nav>
            </div><!-- row -->
        </section><!-- container -->
        
        <section class="container"  id="photo6" style="height:125vh; padding-top:100px;">
            <div class="row">
              <canvas id="canvas6" onclick="draw(event, this.id)"></canvas>
                <img class="img-responsive" src="images/people6.jpg" id="image6" style="width:100%;display:none;">
            </div>
            <div class="row">
              <form>
                <div class="form-group" id="mturk_form">
                  <label for="personCount6"><h4>How many people?</h4></label>
                  <span id="personCount6"><h2>0</h2></span>
                </div>
              </form><!-- /.form -->
              
              <nav>
                <ul class="pager">
                  <li class="previous"><a href="#photo5"><span aria-hidden="true">&larr;</span> Previous Image</a></li>
                  <li class="next"><a href="#photo7">Next Image <span id="thing" aria-hidden="true">&rarr;</span></a></li>
                </ul>
              </nav>
            </div><!-- row -->
        </section><!-- container -->
        
        <section class="container" id="photo7" style="height:125vh; padding-top:100px;">
            <div class="row">
              <canvas id="canvas7" onclick="draw(event, this.id)"></canvas>
              <img class="img-responsive" src="images/people7.jpg" id="image7" style="width:100%;display:none;">
            </div>
            <div class="row">
              <form>
                <div class="form-group" id="mturk_form">
                  <label for="personCount7"><h4>How many people?</h4></label>
                  <span id="personCount7"><h2>0</h2></span>
                </div>
              </form><!-- /.form -->
              
              <nav>
                <ul class="pager">
                  <li class="previous"><a href="#photo6"><span aria-hidden="true">&larr;</span> Previous Image</a></li>
                </ul>
              </nav>
            </div><!-- row -->
        </section><!-- container -->
        

      
    </div> <!-- /container -->
    
    
    <script type="text/javascript">
    //JavaScript goes here
      console.log("javascript working");
      
      var i;
      var image_canvas_array = [];
      for (i = 0; i < 7; i++) {
        image_canvas_array[i] = "canvas" + (i+1);
        console.log(image_canvas_array[i]);
      }
      
      var counter_array = [];
      var position_array = [];
      for (i = 0; i < 7; i++) {
        position_array[i] = [];
        counter_array[i] = 0;
      }
      
      var image_counter;
      var positions;
      

      window.onload = function() {
        var i;
        for (i = 0; i < image_canvas_array.length; i++) {
            var canvas_id = image_canvas_array[i];
            console.log(canvas_id);
            var canvas = document.getElementById(canvas_id);
            var ctx = canvas.getContext("2d");
            //var img = document.getElementById("image1");
            var img = new Image();
            img.src = "./images/people" + (i+1) + ".jpg";
            if (img.width < 700) {
              img.width *= 1.4;
              img.height *= 1.4;
            }
            if (img.width > 900) {
              img.width /= 2;
              img.height /= 2;
            }
            ctx.canvas.width = img.width;
            ctx.canvas.height = img.height;
            //console.log(img.width + " " + img.height);
            ctx.drawImage(img, 0, 0, img.width, img.height);
        }

      };
      
      // Array Remove - By John Resig (MIT Licensed)
      Array.prototype.remove = function(from, to) {
        var rest = this.slice((to || from) + 1 || this.length);
        this.length = from < 0 ? this.length + from : from;
        return this.push.apply(this, rest);
      };
      
      // Stack overflow ty ty
      Array.prototype.contains = function(obj) {
          var i = this.length;
          //console.log("Searching for " + obj.x + ", " + obj.y)
          while (i--) {
              console.log("Found " + this[i].x + ", " + this[i].y);
              if (obj.x - 4 <= this[i].x && 
                  this[i].x <= obj.x + 4 && 
                  obj.y - 4 <= this[i].y &&
                  this[i].y <= obj.y + 4) {
                  console.log("true!");
                  this.remove(i,i);
                  return true;
              }
          }
          return false;
      }
      
      function draw(e, elem_id) {
          var canvas = document.getElementById(elem_id);
          var id = elem_id.charAt(elem_id.length - 1);
          console.log("ID:" + id);
          positions = position_array[id - 1];
          image_counter = counter_array[id - 1];
          
          
          var context = canvas.getContext("2d");
          context.globalCompositeOperation = "source-over";  
          context.fillStyle = "#ffffff";
          
          var pos = getMousePos(canvas, e);
          if (positions.contains(pos)) {
              image_counter -= 1;
          } else {
              image_counter += 1;
              positions.push(pos);
          }
          
          counter_array[id - 1] = image_counter;
          position_array[id - 1] = positions;

          var i,j;
          context.clearRect(0, 0, canvas.width, canvas.height);
          window.onload();
          
          for (i = 0; i < 7; i++) {
            canvas = document.getElementById(image_canvas_array[i]);
            context = canvas.getContext("2d");
            positions = position_array[i];
            for (j = 0; j < positions.length; j++) {
              var posx = positions[j].x;
              var posy = positions[j].y;
              context.fillStyle = "#ffffff";
              context.strokeStyle = "#0f0f0f"

              context.beginPath();
              context.arc(posx, posy, 5, 0, 2*Math.PI);
              context.fill();
              context.stroke();
              context.closePath();
              
            }
          }
          
          var i;
          document.getElementById("pos").innerHTML = "";
          //for (i = 0; i < position_array.length; i++) { 
          //    document.getElementById("pos").innerHTML += "(" + position_array[i].x + ", " + position_array[i].y + ") <br /> ";
          //}
          document.getElementById("personCount" + id).innerHTML = "<h2>" + image_counter + "</h2>";

      }
      
      function getMousePos(canvas, evt) {
          var rect = canvas.getBoundingClientRect();
          return {
            x: evt.clientX - rect.left,
            y: evt.clientY - rect.top
          };
      }
      
      window.draw = draw;

    </script>
    
    

  </body>
    
    
</html>
