<!DOCTYPE html>
<html>
    <head>
      <title>People Counting</title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
      <!-- Latest compiled and minified CSS -->

      <!-- Latest compiled and minified JavaScript -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
      <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
      <!--<script src="mturk.js"></script>-->
      
        <script type="text/javascript" language="JavaScript">
         
        // Given the ID of the assignmentId form field element, populate it
        // with the assignmentId parameter from the URL.  If no assignment ID
        // is present, inform the worker that the HIT is being previewed.
        function populateAssignmentID(field_id) {
          var assignment_id_field = document.getElementById(field_id);
          var paramstr = window.location.search.substring(1);
          var parampairs = paramstr.split("&");
          var i;
          for (i in parampairs) {
            var pair = parampairs[i].split("=");
            if (pair[0] == "assignmentId") {
              if (pair[1] == "ASSIGNMENT_ID_NOT_AVAILABLE") {
                console.log("mrow");
                document.getElementById(previewnotice).innerHTML =
                  "<p><b>You are previewing this HIT.</b>  To perform this HIT, please accept it.</p>";
              } else {
                console.log("here");
                assignment_id_field.value = pair[1];
              }
              return;
            }
          }
        }

// --></script>
    </head>
    
    <body onload="populateAssignmentID('myAssignmentId')">

    <div class="container">
      <div class="panel panel-info" id="instructionsPanel">
        <div class="panel-heading">
          <h3 class="panel-title">
          <a class="accordion-toggle" data-toggle="collapse" data-parent="#instructionsPanel" href="#instructions">Instructions</a></h3>
        </div>
        <div class="panel-body panel-collapse collapse in" id="instructions">
          <h3>Please make sure you accept the HIT before starting the task!</h3>
          <p>Count the number of unique people that appear in each photo.</p>
          <ul>
              <li>To count the people in each picture, just click on each distinguishable person in the image to help you count.</li>
              <li>To remove a marking, just click on it.</li>
              <li>A counter will keep track of the number of people for you.</li>
              <li>Use the previous and next buttons to navigate to the previous or next image.</li>
          </ul>
          
          <p>You will be paid a flat rate for completing the HIT, and then earn a bonus of $0.01 for every 5 people you identify.</p>
          
          <p>Here are some examples to help you:</p>
          <ul>
            <li>Example 1</li>
            <li>Example 2</li>
            <li>Example 3</li>
          </ul>
        </div>
      </div>
      
      <form id="mturk_form" action="https://workersandbox.mturk.com/mturk/externalSubmit" method="POST">
        <section class="container" id="photo1" style="height:150vh;padding-top:100px;">
          <div class="row">
            <canvas id="canvas1" onclick="draw(event, this.id)"></canvas>
            <img class="img-responsive" src="images/people1.jpg" id="image1" style="width:100%;display:none;">
          </div>
          <div class="row">
            <label for="personCount1"><h4>How many people?</h4></label>
            <input type="number" id="personCount1" readonly="true" value="0">
            <nav>
              <ul class="pager">
                <li class="next"><a href="#photo2">Next Image <span id="thing" aria-hidden="true">&rarr;</span></a></li>
              </ul>
            </nav>
          </div>
        </section>
        
        <section class="container" id="photo2" style="height:125vh; padding-top:100px;">
          <div class="row">
            <canvas id="canvas2" onclick="draw(event, this.id)"></canvas>
            <img class="img-responsive" src="images/people2.jpg" id="image2" style="width:100%;display:none;">
          </div>
          <div class="row">
            <label for="personCount2"><h4>How many people?</h4></label>
            <input type="number" id="personCount2" readonly="true" value="0">
            <nav>
              <ul class="pager">
                <li class="previous"><a href="#photo1"><span aria-hidden="true">&larr;</span> Previous Image</a></li>
                <li class="next"><a href="#photo3">Next Image <span id="thing" aria-hidden="true">&rarr;</span></a></li>
              </ul>
            </nav>
          </div>
        </section>
        
        <section class="container" style="height:125vh; padding-top:100px;" id="photo3">
          <div class="row">
            <canvas id="canvas3" onclick="draw(event, this.id)"></canvas>
            <img class="img-responsive" src="images/people3.jpg" id="image3" style="width:100%;display:none;">
          </div>
          <div class="row">
            <label for="personCount3"><h4>How many people?</h4></label>
            <input type="number" id="personCount3" readonly="true" value="0">
            <nav>
              <ul class="pager">
                <li class="previous"><a href="#photo2"><span aria-hidden="true">&larr;</span> Previous Image</a></li>
                <li class="next"><a href="#photo4">Next Image <span id="thing" aria-hidden="true">&rarr;</span></a></li>
              </ul>
            </nav>
          </div>
        </section>

        <section class="container" id="photo4" style="height:125vh; padding-top:100px;">
          <div class="row">
            <canvas id="canvas4" onclick="draw(event, this.id)"></canvas>
            <img class="img-responsive" src="images/people4.jpg" id="image4" style="width:100%;display:none;">
          </div>
          <div class="row">
            <label for="personCount4"><h4>How many people?</h4></label>
            <input type="number" id="personCount4" readonly="true" value="0">
            <nav>
              <ul class="pager">
                <li class="previous"><a href="#photo3"><span aria-hidden="true">&larr;</span> Previous Image</a></li>
                <li class="next"><a href="#photo5">Next Image <span id="thing" aria-hidden="true">&rarr;</span></a></li>
              </ul>
            </nav>
          </div>
        </section>
        
        <section class="container" id="photo5" style="height:125vh; padding-top:100px;">
          <div class="row">
            <canvas id="canvas5" onclick="draw(event, this.id)"></canvas>
            <img class="img-responsive" src="images/people5.jpg" id="image5" style="width:100%;display:none;">
          </div>
          <div class="row">
            <label for="personCount5"><h4>How many people?</h4></label>
            <input type="number" id="personCount5" readonly="true" value="0">
            <nav>
              <ul class="pager">
                <li class="previous"><a href="#photo4"><span aria-hidden="true">&larr;</span> Previous Image</a></li>
                <li class="next"><a href="#photo6">Next Image <span id="thing" aria-hidden="true">&rarr;</span></a></li>
              </ul>
            </nav>
          </div>
        </section>
        
        <section class="container"  id="photo6" style="height:125vh; padding-top:100px;">
            <div class="row">
              <canvas id="canvas6" onclick="draw(event, this.id)"></canvas>
              <img class="img-responsive" src="images/people6.jpg" id="image6" style="width:100%;display:none;">
            </div>
            <div class="row">
              <label for="personCount6"><h4>How many people?</h4></label>
              <input type="number" id="personCount6" readonly="true" value="0">
              <nav>
                <ul class="pager">
                  <li class="previous"><a href="#photo5"><span aria-hidden="true">&larr;</span> Previous Image</a></li>
                  <li class="next"><a href="#photo7">Next Image <span id="thing" aria-hidden="true">&rarr;</span></a></li>
                </ul>
              </nav>
            </div>
        </section>
        
        <section class="container" id="photo7" style="height:125vh; padding-top:100px;">
            <div class="row">
              <canvas id="canvas7" onclick="draw(event, this.id)"></canvas>
              <img class="img-responsive" src="images/people7.jpg" id="image7" style="width:100%;display:none;">
            </div>
            <div class="row">
              <label for="personCount7"><h4>How many people?</h4></label>
              <input type="number" id="personCount7" readonly="true" value="0">
              <nav>
                <ul class="pager">
                  <li class="previous"><a href="#photo6"><span aria-hidden="true">&larr;</span> Previous Image</a></li>
                </ul>
                <input type="submit" name="submit" value="Submit Answers" class="btn btn-default" />
              </nav>
            </div>
        </section>
        <input type="hidden" name="assignmentId" id="myAssignmentId" value="" />
      </form>
    </div> 

    <script type="text/javascript">

      var i;
      var image_canvas_array = [];
      for (i = 0; i < 7; i++) {
        image_canvas_array[i] = "canvas" + (i+1);
        //console.log(image_canvas_array[i]);
      }
      
      var counter_array = [];
      var position_array = [];
      for (i = 0; i < 7; i++) {
        position_array[i] = [];
        counter_array[i] = 0;
      }
      
      var image_counter;
      var positions;
      

      window.onload = function() {
        var i;
        for (i = 0; i < image_canvas_array.length; i++) {
            var canvas_id = image_canvas_array[i];
            //console.log(canvas_id);
            var canvas = document.getElementById(canvas_id);
            var ctx = canvas.getContext("2d");
            var img = new Image();
            img.src = "./images/people" + (i+1) + ".jpg";
            
            if (img.width < 700) {
              var temp_width = img.width * 1.2;
              var temp_height = img.height * 1.2;
              img.width = Math.floor(temp_width);
              img.height = Math.floor(temp_height);
            }
            
            if (img.width > 900) {
              img.width = img.width / 2;
              img.height = img.height / 2;
            }
            ctx.canvas.width = img.width;
            ctx.canvas.height = img.height;
            ctx.drawImage(img, 0, 0, img.width, img.height);
        }

      };
      
      Array.prototype.remove = function(from, to) {
        var rest = this.slice((to || from) + 1 || this.length);
        this.length = from < 0 ? this.length + from : from;
        return this.push.apply(this, rest);
      };
      
      Array.prototype.contains = function(obj) {
          var i = this.length;
          while (i--) {
              if (obj.x - 4 <= this[i].x && 
                  this[i].x <= obj.x + 4 && 
                  obj.y - 4 <= this[i].y &&
                  this[i].y <= obj.y + 4) {
                  this.remove(i,i);
                  return true;
              }
          }
          return false;
      }
      
      function draw(e, elem_id) {
          var canvas = document.getElementById(elem_id);
          var id = elem_id.charAt(elem_id.length - 1);
          //console.log("ID:" + id);
          positions = position_array[id - 1];
          image_counter = counter_array[id - 1];
          
          
          var context = canvas.getContext("2d");
          context.globalCompositeOperation = "source-over";  
          context.fillStyle = "#ffffff";
          
          var pos = getMousePos(canvas, e);
          if (positions.contains(pos)) {
              image_counter -= 1;
          } else {
              image_counter += 1;
              positions.push(pos);
          }
          
          counter_array[id - 1] = image_counter;
          position_array[id - 1] = positions;

          var i,j;
          context.clearRect(0, 0, canvas.width, canvas.height);
          window.onload();
          
          for (i = 0; i < 7; i++) {
            canvas = document.getElementById(image_canvas_array[i]);
            context = canvas.getContext("2d");
            positions = position_array[i];
            for (j = 0; j < positions.length; j++) {
              var posx = positions[j].x;
              var posy = positions[j].y;
              context.fillStyle = "#ffffff";
              context.strokeStyle = "#0f0f0f"

              context.beginPath();
              context.arc(posx, posy, 5, 0, 2*Math.PI);
              context.fill();
              context.stroke();
              context.closePath();
              
            }
          }
          
          var i;
          document.getElementById("personCount" + id).value = image_counter;


      }
      
      function getMousePos(canvas, evt) {
          var rect = canvas.getBoundingClientRect();
          return {
            x: evt.clientX - rect.left,
            y: evt.clientY - rect.top
          };
      }
      
      window.draw = draw;

    </script>
    
    

  </body>
    
    
</html>
